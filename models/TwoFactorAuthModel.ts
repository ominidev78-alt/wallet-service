import { pool } from '../config/db.js'export interface TwoFactorAuth {  id: number  userId: number  secret: string  enabled: boolean  method: string  attempts: number  lockedUntil: Date | null  updatedAt: Date  createdAt: Date}export class TwoFactorAuthModel {  static async findByUserId(userId: number | string): Promise<TwoFactorAuth | null> {    const { rows } = await pool.query(      `      SELECT *      FROM user_two_factor_auth      WHERE user_id = $1      LIMIT 1;      `,      [userId]    )    return rows[0] || null  }  static async isLocked(userId: number | string): Promise<boolean> {    const config = await this.findByUserId(userId)    if (!config || !config.lockedUntil) return false    return new Date() < new Date(config.lockedUntil)  }  static async recordFailure(userId: number | string): Promise<{ attempts: number; locked: boolean }> {    const { rows } = await pool.query(      `      UPDATE user_two_factor_auth      SET         attempts = attempts + 1,        locked_until = CASE WHEN attempts + 1 >= 3 THEN NOW() + INTERVAL '15 minutes' ELSE locked_until END,        updated_at = NOW()      WHERE user_id = $1      RETURNING attempts, (locked_until > NOW()) as locked;      `,      [userId]    )    return rows[0]  }  static async recordSuccess(userId: number | string): Promise<void> {    await pool.query(      `      UPDATE user_two_factor_auth      SET attempts = 0, locked_until = NULL, updated_at = NOW()      WHERE user_id = $1;      `,      [userId]    )  }  static async verifyRecoveryCode(userId: number | string, code: string): Promise<boolean> {    return false   }  static async addAuditLog(data: {    userId: number | string    action: string    method: string    context: string    ipAddress: string | null    userAgent: string | null    success: boolean    failureReason?: string  }): Promise<void> {    await pool.query(      `      INSERT INTO two_factor_audit_logs (user_id, action, method, context, ip_address, user_agent, success, failure_reason)      VALUES ($1, $2, $3, $4, $5, $6, $7, $8);      `,      [data.userId, data.action, data.method, data.context, data.ipAddress, data.userAgent, data.success, data.failureReason || null]    )  }  static async create({ userId, secret, method = 'TOTP' }: { userId: number | string; secret: string; method?: string }): Promise<TwoFactorAuth> {    const { rows } = await pool.query(      `      INSERT INTO user_two_factor_auth (user_id, secret, method, enabled)      VALUES ($1, $2, $3, false)      ON CONFLICT (user_id, method)      DO UPDATE SET        secret = EXCLUDED.secret,        enabled = false,        updated_at = NOW()      RETURNING *;      `,      [userId, secret, method]    )    return rows[0]  }  static async enable(userId: number | string, method: string = 'TOTP'): Promise<TwoFactorAuth> {    const { rows } = await pool.query(      `      UPDATE user_two_factor_auth      SET enabled = true, updated_at = NOW()      WHERE user_id = $1 AND method = $2      RETURNING *;      `,      [userId, method]    )    return rows[0]  }  static async disable(userId: number | string, method: string = 'TOTP'): Promise<TwoFactorAuth> {    const { rows } = await pool.query(      `      UPDATE user_two_factor_auth      SET enabled = false, updated_at = NOW()      WHERE user_id = $1 AND method = $2      RETURNING *;      `,      [userId, method]    )    return rows[0]  }}