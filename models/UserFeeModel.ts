import { pool } from '../config/db.js'export interface UserFees {  user_id: number;  pix_in_percent: number;  pix_out_percent: number;  pix_in_fee_type: string;  pix_in_fee_value: number;  pix_out_fee_type: string;  pix_out_fee_value: number;  created_at?: Date;  updated_at?: Date;}export class UserFeeModel {  static async getByUserId(userId: number | string): Promise<UserFees | null> {    console.log('[UserFeeModel.getByUserId] Buscando taxas para userId:', userId, 'Tipo:', typeof userId)    const numericUserId = Number(userId)    if (!Number.isFinite(numericUserId) || numericUserId <= 0) {      console.error('[UserFeeModel.getByUserId] ❌ UserId inválido:', userId)      return null    }    try {      const { rows } = await pool.query(        `        SELECT          user_id,          pix_in_percent,          pix_out_percent,          pix_in_fee_type,          pix_in_fee_value,          pix_out_fee_type,          pix_out_fee_value,          created_at,          updated_at        FROM user_fees        WHERE user_id = $1        LIMIT 1;        `,        [numericUserId]      )      console.log('[UserFeeModel.getByUserId] Query executada. Linhas encontradas:', rows.length)      if (rows.length > 0) {        const row = rows[0]        console.log('[UserFeeModel.getByUserId] Dados encontrados (raw):', row)        const result: UserFees = {          user_id: Number(row.user_id),          pix_in_percent: Number(row.pix_in_percent) || 0,          pix_out_percent: Number(row.pix_out_percent) || 0,          pix_in_fee_type: row.pix_in_fee_type || 'PERCENT',          pix_in_fee_value: Number(row.pix_in_fee_value) || 0,          pix_out_fee_type: row.pix_out_fee_type || 'PERCENT',          pix_out_fee_value: Number(row.pix_out_fee_value) || 0,          created_at: row.created_at,          updated_at: row.updated_at        }        console.log('[UserFeeModel.getByUserId] Dados processados:', result)        return result      }      console.log('[UserFeeModel.getByUserId] ⚠️ Nenhuma linha encontrada para userId:', numericUserId)      return null    } catch (error: any) {      console.error('[UserFeeModel.getByUserId] ❌ Erro na query:', error)      console.error('[UserFeeModel.getByUserId] Stack:', error.stack)      throw error    }  }  static async upsertForUser(userId: number | string, {     pixInPercent,     pixOutPercent,    pixInFeeType = 'PERCENT',    pixInFeeValue = 0,    pixOutFeeType = 'PERCENT',    pixOutFeeValue = 0  }: {    pixInPercent: number;    pixOutPercent: number;    pixInFeeType?: string;    pixInFeeValue?: number;    pixOutFeeType?: string;    pixOutFeeValue?: number;  }): Promise<UserFees | null> {    console.log('[UserFeeModel.upsertForUser] Salvando taxas:', {      userId,      pixInPercent,      pixOutPercent,      pixInFeeType,      pixInFeeValue,      pixOutFeeType,      pixOutFeeValue    })    try {      const { rows } = await pool.query(        `        INSERT INTO user_fees (          user_id,          pix_in_percent,          pix_out_percent,          pix_in_fee_type,          pix_in_fee_value,          pix_out_fee_type,          pix_out_fee_value        )        VALUES ($1, $2, $3, $4, $5, $6, $7)        ON CONFLICT (user_id)        DO UPDATE SET          pix_in_percent = EXCLUDED.pix_in_percent,          pix_out_percent = EXCLUDED.pix_out_percent,          pix_in_fee_type = EXCLUDED.pix_in_fee_type,          pix_in_fee_value = EXCLUDED.pix_in_fee_value,          pix_out_fee_type = EXCLUDED.pix_out_fee_type,          pix_out_fee_value = EXCLUDED.pix_out_fee_value,          updated_at = NOW()        RETURNING          user_id,          pix_in_percent,          pix_out_percent,          pix_in_fee_type,          pix_in_fee_value,          pix_out_fee_type,          pix_out_fee_value,          created_at,          updated_at;        `,        [          userId,           pixInPercent,           pixOutPercent,          pixInFeeType || 'PERCENT',          Number(pixInFeeValue) || 0,          pixOutFeeType || 'PERCENT',          Number(pixOutFeeValue) || 0        ]      )      console.log('[UserFeeModel.upsertForUser] Taxas salvas:', rows[0])      return rows[0] || null    } catch (error) {      console.error('[UserFeeModel.upsertForUser] ❌ Erro ao salvar taxas:', error)      throw error    }  }  static calculateFee(amount: number, feeType: string, feeValue: number): number {    console.log('[UserFeeModel.calculateFee] Calculando taxa:', {      amount,      feeType,      feeValue,      amountType: typeof amount,      feeValueType: typeof feeValue    })    if (!amount || amount <= 0) {      console.log('[UserFeeModel.calculateFee] Valor inválido ou zero, retornando 0')      return 0    }    if (!feeValue || feeValue <= 0) {      console.log('[UserFeeModel.calculateFee] Taxa inválida ou zero, retornando 0')      return 0    }    let calculatedFee = 0    if (feeType === 'FIXED') {      calculatedFee = Number(feeValue)      console.log('[UserFeeModel.calculateFee] Taxa FIXA:', calculatedFee)    } else {      calculatedFee = (Number(amount) * Number(feeValue)) / 100      console.log('[UserFeeModel.calculateFee] Taxa PERCENTUAL:', {        amount: Number(amount),        percent: Number(feeValue),        calculated: calculatedFee      })    }    const roundedFee = Number(calculatedFee.toFixed(2))    console.log('[UserFeeModel.calculateFee] Taxa final calculada:', roundedFee)    return roundedFee  }  static calculatePixInFee(amount: number, fees: UserFees | null): number {    if (!amount || amount <= 0) return 0    if (!fees) return 0    let totalFee = 0    if (fees.pix_in_fee_type === 'FIXED' && fees.pix_in_fee_value > 0) {      totalFee += Number(fees.pix_in_fee_value)    }    if (fees.pix_in_percent > 0) {      totalFee += (Number(amount) * Number(fees.pix_in_percent)) / 100    }    return Number(totalFee.toFixed(2))  }  static calculatePixOutFee(amount: number, fees: UserFees | null): number {    if (!amount || amount <= 0) return 0    if (!fees) return 0    let totalFee = 0    if (fees.pix_out_fee_type === 'FIXED' && fees.pix_out_fee_value > 0) {      totalFee += Number(fees.pix_out_fee_value)    }    if (fees.pix_out_percent > 0) {      totalFee += (Number(amount) * Number(fees.pix_out_percent)) / 100    }    return Number(totalFee.toFixed(2))  }}