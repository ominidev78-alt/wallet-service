import { Request, Response, NextFunction } from 'express'import jwt from 'jsonwebtoken'import { UserModel } from '../models/UserModel.js'import { env } from '../config/env.js'export async function hybridAuth(req: Request, res: Response, next: NextFunction) {    try {        const authHeader = req.headers.authorization || ''        const token = authHeader.startsWith('Bearer ') ? authHeader.slice(7) : null        if (token) {            try {                const decoded: any = jwt.verify(token, env.JWT_USER_SECRET)                req.user = decoded                return next()            } catch (err) {                console.log('[hybridAuth] JWT verification failed, trying app_id/app_secret')            }        }        const appId = req.headers.app_id || req.headers['app-id'] || req.headers.App_id || req.headers['App-Id']        const appSecret = req.headers.app_secret || req.headers['app-secret'] || req.headers.App_secret || req.headers['App-Secret']        if (appId && appSecret) {            const user = await UserModel.findByAppId(String(appId))            if (!user) {                return res.status(401).json({                    ok: false,                    error: 'Unauthorized',                    message: 'app_id inválido.'                })            }            const storedSecret = user.client_secret || user.app_secret_hash            if (storedSecret !== String(appSecret)) {                return res.status(401).json({                    ok: false,                    error: 'Unauthorized',                    message: 'app_secret inválido.'                })            }            req.user = {                id: user.id,                userId: user.id,                appId: user.app_id,                email: user.email            }            return next()        }        return res.status(401).json({            ok: false,            error: 'Unauthorized',            message: 'Token ou app_id/app_secret ausente.'        })    } catch (err) {        console.error('[hybridAuth] Error:', err)        return res.status(401).json({            ok: false,            error: 'Unauthorized',            message: 'Erro na autenticação.'        })    }}