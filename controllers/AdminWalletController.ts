import { Request, Response, NextFunction } from 'express'import Joi from 'joi'import { pool } from '../config/db.js'import { WalletModel } from '../models/WalletModel.js'import { HttpError } from '../core/HttpError.js'import { Wallet } from '../types/wallet.js'const adjustSchema = Joi.object({  type: Joi.string().valid('CREDIT', 'DEBIT').required(),  amount: Joi.number().positive().required(),  description: Joi.string().allow('', null)})class AdminWalletController {  async #getOrCreateUserWallet(userId: number, currencyParam?: string): Promise<Wallet> {    if (!Number.isFinite(userId) || userId <= 0) {      throw new HttpError(400, 'InvalidUserId')    }    const currency = ((currencyParam as string) || 'BRL').toUpperCase()    let wallet = await WalletModel.getUserWallet(userId, currency)    if (!wallet) {      wallet = await WalletModel.createUserWallet(userId, currency)    }    return wallet  }  async getUserWallet(req: Request, res: Response, next: NextFunction) {    try {      const userId = Number(req.params.id)      const wallet = await this.#getOrCreateUserWallet(userId, req.query.currency as string)      return res.json({        ok: true,        data: wallet      })    } catch (err) {      next(err)    }  }  async getUserLedger(req: Request, res: Response, next: NextFunction) {    try {      const userId = Number(req.params.id)      const wallet = await this.#getOrCreateUserWallet(userId, req.query.currency as string)      let limit = Number(req.query.limit || 100)      if (!Number.isFinite(limit) || limit <= 0 || limit > 1000) {        limit = 100      }      const from = req.query.from as string || null      const to = req.query.to as string || null      const params: any[] = [wallet.id]      let where = 'wallet_id = $1'      if (from) {        params.push(from)        where += ` AND created_at >= $${params.length}`      }      if (to) {        params.push(to)        where += ` AND created_at <= $${params.length}`      }      params.push(limit)      const query = `        SELECT          id,          wallet_id,          direction AS type,          amount,          description,          meta,          created_at        FROM ledger_entries        WHERE ${where}        ORDER BY created_at DESC        LIMIT $${params.length}      `      const { rows } = await pool.query(query, params)      return res.json({        ok: true,        data: rows      })    } catch (err) {      next(err)    }  }  async adjustBalance(req: Request, res: Response, next: NextFunction) {    try {      const userId = Number(req.params.id)      const { value, error } = adjustSchema.validate(req.body, {        abortEarly: false      })      if (error) {        throw new HttpError(400, 'ValidationError', { details: error.details })      }      const wallet = await this.#getOrCreateUserWallet(userId, req.query.currency as string)      const currentBalance = Number(wallet.balance || 0)      const amount = Number(value.amount)      let newBalance: number      if (value.type === 'CREDIT') {        newBalance = currentBalance + amount      } else {        if (currentBalance < amount) {          throw new HttpError(400, 'InsufficientFunds', {            message: 'Saldo insuficiente para débito'          })        }        newBalance = currentBalance - amount      }      const updatedWallet = await WalletModel.updateBalance(wallet.id, newBalance)      const description =        value.description ||        (value.type === 'CREDIT'          ? 'Ajuste manual de crédito (admin)'          : 'Ajuste manual de débito (admin)')      const meta = {        adminAdjustment: true,        type: value.type      }      const insertLedgerQuery = `        INSERT INTO ledger_entries          (wallet_id, direction, amount, description, meta, external_id)        VALUES          ($1, $2, $3, $4, $5::jsonb, $6)        RETURNING id, wallet_id, direction AS type, amount, description, meta, created_at      `      const { rows } = await pool.query(insertLedgerQuery, [        wallet.id,        value.type,        amount,        description,        JSON.stringify(meta),        `ADJUST_${Date.now()}`      ])      const ledgerEntry = rows[0] || null      return res.json({        ok: true,        data: {          wallet: updatedWallet,          ledgerEntry        }      })    } catch (err) {      next(err)    }  }}export const adminWalletController = new AdminWalletController()